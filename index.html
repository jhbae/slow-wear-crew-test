<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¬ë¡œìš° ì›¨ì–´ í¬ë£¨ - ì„¤ë¬¸ ì„ íƒ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* CSSëŠ” ê¸°ì¡´ íŒŒì¼ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€í•˜ê³ , ì´ íŒŒì¼ì—ì„œëŠ” í† ìŠ¤íŠ¸/ëŒ€ì‹œë³´ë“œ ê´€ë ¨ CSSë§Œ ì œê±°í•©ë‹ˆë‹¤. */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .content { padding: 30px; }
        .login-screen, .survey-select-screen { display: none; }
        .login-screen.active, .survey-select-screen.active { display: block; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; margin-bottom: 20px;}
        .btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn:hover { transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; margin-top: 10px; }
        .link-grid { display: flex; gap: 20px; margin-top: 30px;}
        .btn-link { flex: 1; display: block; padding: 18px; text-decoration: none; border-radius: 10px; font-size: 16px; font-weight: 600; text-align: center; color: white; transition: transform 0.2s; }
        #link-sensory { background: #FF99AA; }
        #link-progress { background: #667eea; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ìŠ¬ë¡œìš° ì›¨ì–´ í¬ë£¨</h1>
            <p>ì„¤ë¬¸ ì„ íƒ ë° ì ‘ì†</p>
        </div>

        <div class="content">
            <div class="login-screen active">
                <div class="input-group">
                    <label>ì½”ë“œ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</label>
                    <input type="text" id="loginInput" placeholder="ì°¸ê°€ì ì½”ë“œ ë˜ëŠ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
                </div>
                <button class="btn" onclick="login()">ì…ë ¥</button>
            </div>

            <div class="survey-select-screen">
                <h2>ğŸ‘‹ ì„¤ë¬¸ ì„ íƒ</h2>
                <p style="margin: 10px 0 20px; color: #555;">ì§„í–‰í•˜ì‹¤ ì„¤ë¬¸ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
                <div class="link-grid">
                    <a id="link-sensory" href="sensory.html#dashboard" class="btn-link">
                        ğŸ’† ê°ê° ì²´í¬ë¦¬ìŠ¤íŠ¸ (1ì£¼/4ì£¼)
                    </a>
                    <a id="link-progress" href="progress.html#dashboard" class="btn-link">
                        ğŸ“ˆ ì£¼ì°¨ë³„ ë³€í™”ê¸°ë¡ (1~4ì£¼)
                    </a>
                </div>
                <button class="btn btn-secondary" onclick="logout()" style="margin-top: 30px;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCIjXYco5ydEsXcap0kq2hvRstNT4vjorY",
            authDomain: "slow-wear-crew.firebaseapp.com",
            projectId: "slow-wear-crew",
            storageBucket: "slow-wear-crew.firebasestorage.app",
            messagingSenderId: "281669334869",
            databaseURL: "https://slow-wear-crew-default-rtdb.asia-southeast1.firebasedatabase.app",
            appId: "1:281669334869:web:e8ebacf777c25127a5e1dc",
            measurementId: "G-ZSQMNN9WSH"
        };
        let app, database;
        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (error) { console.log("Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤:", error); }

        let currentUser = null;
        let currentSessionId = null;
        let isAdmin = false;

        // í™”ë©´ ì „í™˜ (login/selectë§Œ)
        function showScreen(screenName) {
            document.querySelectorAll('.login-screen, .survey-select-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.querySelector(`.${screenName}`).classList.add('active');
        }

        // ë¡œê·¸ì¸
        async function login() {
            const input = document.getElementById('loginInput').value.trim();
            if (!input || !database) return;

            try {
                // 1. ê´€ë¦¬ì í™•ì¸
                const adminSnapshot = await database.ref(`admin/${input}`).once('value');
                if (adminSnapshot.exists()) {
                    isAdmin = true;
                    sessionStorage.setItem('isAdmin', 'true');
                    location.hash = '#select';
                    return;
                }
                
                // 2. ì°¸ê°€ì í™•ì¸ ë° ì„¸ì…˜ ì •ë³´ ë¡œë“œ
                const participantsSnapshot = await database.ref('participants')
                    .orderByChild('accessCode')
                    .equalTo(input.toUpperCase())
                    .once('value');
                
                const participants = participantsSnapshot.val();
                
                if (participants && Object.keys(participants).length > 0) {
                    const userId = Object.keys(participants)[0];
                    const userData = participants[userId];

                    const sessionSnapshot = await database.ref(`sessions/${userData.sessionId}`).once('value');
                    const sessionData = sessionSnapshot.val();
                    
                    if (!sessionData || !sessionData.sensorySurveyTemplateId || !sessionData.wearingProgressSurveyTemplateId) {
                         alert('ì˜¤ë¥˜: ì´ ì„¸ì…˜ì— í• ë‹¹ëœ ì„¤ë¬¸ì§€ í…œí”Œë¦¿ ì •ë³´ê°€ ë¶ˆì™„ì „í•©ë‹ˆë‹¤.');
                         return;
                    }

                    // âœ… [í•µì‹¬] ë‘ í…œí”Œë¦¿ IDë¥¼ ëª¨ë‘ ì €ì¥
                    sessionStorage.setItem('currentUser', userId);
                    sessionStorage.setItem('currentSessionId', userData.sessionId);
                    sessionStorage.setItem('accessCode', input.toUpperCase());
                    sessionStorage.setItem('sensorySurveyTemplateId', sessionData.sensorySurveyTemplateId);
                    sessionStorage.setItem('wearingProgressSurveyTemplateId', sessionData.wearingProgressSurveyTemplateId);
                    
                    // ë§ˆì§€ë§‰ ì ‘ì† ì‹œê°„ ì—…ë°ì´íŠ¸
                    await database.ref(`participants/${userId}/lastAccess`).set(new Date().toISOString());
                    
                    location.hash = '#select'; 
                } else {
                    alert('ìœ íš¨í•˜ì§€ ì•Šì€ ì½”ë“œ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            sessionStorage.clear();
            document.getElementById('loginInput').value = '';
            location.hash = '#login';
        }

        // ë¼ìš°í„°
        async function handleRouteChange() {
            const hash = window.location.hash || '#login';
            const savedUser = sessionStorage.getItem('currentUser');
            const savedIsAdmin = sessionStorage.getItem('isAdmin');

            if (hash === '#select') {
                if (!savedUser && !savedIsAdmin) return location.hash = '#login';
                // ê´€ë¦¬ìëŠ” ì´ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì•„ì›ƒë§Œ ê°€ëŠ¥
                showScreen('survey-select-screen'); 
                
            } else { // '#login'
                if (savedUser || savedIsAdmin) {
                    location.hash = '#select'; 
                } else {
                    showScreen('login-screen');
                }
            }
        }

        window.addEventListener('load', handleRouteChange);
        window.addEventListener('hashchange', handleRouteChange);
        document.getElementById('loginInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') login(); });
    </script>
</body>
</html>
